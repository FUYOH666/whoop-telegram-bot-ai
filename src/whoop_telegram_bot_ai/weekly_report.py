"""–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç—á–µ—Ç–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º LLM."""

import logging
from datetime import date, timedelta
from typing import Any

from whoop_telegram_bot_ai.analytics import WhoopAnalytics
from whoop_telegram_bot_ai.llm_client import LLMClient

logger = logging.getLogger(__name__)


class WeeklyReportGenerator:
    """–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤."""

    def __init__(self, analytics: WhoopAnalytics, llm_client: LLMClient):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –æ—Ç—á–µ—Ç–æ–≤.

        Args:
            analytics: –≠–∫–∑–µ–º–ø–ª—è—Ä WhoopAnalytics
            llm_client: –≠–∫–∑–µ–º–ø–ª—è—Ä LLMClient –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞
        """
        self.analytics = analytics
        self.llm_client = llm_client

    async def generate_weekly_report(self, start_date: date | None = None, end_date: date | None = None) -> str:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ —á–µ—Ä–µ–∑ LLM.

        Args:
            start_date: –ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 7 –¥–Ω–µ–π –Ω–∞–∑–∞–¥)
            end_date: –ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è)

        Returns:
            –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç –≤ –≤–∏–¥–µ —Ç–µ–∫—Å—Ç–∞
        """
        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ –Ω–µ–¥–µ–ª—é
        stats = self.analytics.get_weekly_stats(start_date, end_date)

        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è LLM
        prompt = self._build_weekly_report_prompt(stats)

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç —á–µ—Ä–µ–∑ LLM
        try:
            report = await self.llm_client._call_openrouter(prompt, max_retries=3, max_tokens=2000)
            return report if report else self._generate_fallback_report(stats)
        except Exception as e:
            logger.error(f"Failed to generate weekly report via LLM: {e}")
            return self._generate_fallback_report(stats)

    def _build_weekly_report_prompt(self, stats: dict[str, Any]) -> str:
        """
        –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞.

        Args:
            stats: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é

        Returns:
            –ü—Ä–æ–º–ø—Ç –¥–ª—è LLM
        """
        period = stats.get("period", {})
        recovery = stats.get("recovery", {})
        sleep = stats.get("sleep", {})
        strain = stats.get("strain", {})
        workouts = stats.get("workouts", {})
        caffeine = stats.get("caffeine", {})
        trends = stats.get("trends", {})

        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–µ—Ä–∏–æ–¥ {period.get('start', 'N/A')} - {period.get('end', 'N/A')} ({period.get('days', 0)} –¥–Ω–µ–π):

**Recovery (–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ):**
- –°—Ä–µ–¥–Ω–∏–π Recovery: {recovery.get('avg', 'N/A')}%
- –ú–∏–Ω–∏–º—É–º: {recovery.get('min', 'N/A')}%
- –ú–∞–∫—Å–∏–º—É–º: {recovery.get('max', 'N/A')}%
- –¢—Ä–µ–Ω–¥: {recovery.get('trend', 'N/A')}
- –°—Ä–µ–¥–Ω–∏–π HRV: {recovery.get('avg_hrv', 'N/A')}ms
- –°—Ä–µ–¥–Ω–∏–π RHR: {recovery.get('avg_rhr', 'N/A')} bpm

**–°–æ–Ω:**
- –°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {sleep.get('avg_duration_hours', 'N/A')} —á–∞—Å–æ–≤
- –°—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {sleep.get('avg_efficiency', 'N/A')}%
- –°—Ä–µ–¥–Ω—è—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: {sleep.get('avg_consistency', 'N/A')}%
- –°—Ä–µ–¥–Ω–∏–π Deep sleep: {sleep.get('avg_deep_sleep', 'N/A')} –º–∏–Ω—É—Ç
- –°—Ä–µ–¥–Ω–∏–π REM sleep: {sleep.get('avg_rem_sleep', 'N/A')} –º–∏–Ω—É—Ç

**Strain (–ù–∞–≥—Ä—É–∑–∫–∞):**
- –°—Ä–µ–¥–Ω–∏–π Strain: {strain.get('avg', 'N/A')}
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π Strain: {strain.get('max', 'N/A')}

**–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:**
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: {workouts.get('count', 0)}
- –°—Ä–µ–¥–Ω–∏–π Activity Strain: {workouts.get('avg_strain', 'N/A')}
- –û–±—â–∞—è —ç–Ω–µ—Ä–≥–∏—è: {workouts.get('total_energy', 'N/A')} –∫–∞–ª–æ—Ä–∏–π

**–ö–æ—Ñ–µ–∏–Ω:**
- –î–Ω–µ–π —Å –∫–æ—Ñ–µ–∏–Ω–æ–º: {caffeine.get('days_with', 0)} –∏–∑ {caffeine.get('total_days', 0)}

**–¢—Ä–µ–Ω–¥—ã:**
- Recovery —Ç—Ä–µ–Ω–¥: {trends.get('recovery', 'N/A')}
- HRV —Ç—Ä–µ–Ω–¥: {trends.get('hrv', 'N/A')}

–°–æ–∑–¥–∞–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ñ–æ—Ä–º–∞—Ç–µ:

1. **–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ** (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
   - –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –Ω–µ–¥–µ–ª–∏
   - –ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã

2. **–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ?** (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
   - –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
   - –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã
   - –ß—Ç–æ —Å—Ç–æ–∏—Ç –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –¥–µ–ª–∞—Ç—å

3. **–ì–¥–µ –µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è?** (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
   - –û–±–ª–∞—Å—Ç–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
   - –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
   - –ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å

4. **–ö–∞–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ç—ã –∑–∞–º–µ—Ç–∏–ª?** (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
   - –°–≤—è–∑–∏ –º–µ–∂–¥—É –º–µ—Ç—Ä–∏–∫–∞–º–∏
   - –í–ª–∏—è–Ω–∏–µ —Ñ–∞–∫—Ç–æ—Ä–æ–≤ (–∫–æ—Ñ–µ–∏–Ω, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, —Å–æ–Ω)
   - –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è

5. **–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –Ω–µ–¥–µ–ª—é** (4-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)
   - –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã
   - –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
   - –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

–ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏–Ω—Ü–∏–ø—ã –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏—è:
- –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤ –Ω–∞—Å—Ç–æ—è—â–µ–º –≤—Ä–µ–º–µ–Ω–∏
- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞ –∏ —É–ª—É—á—à–µ–Ω–∏—è
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ–±—Ä–∞–∑—ã –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –°–≤—è–∑—å –¥–µ–π—Å—Ç–≤–∏–π —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏

**–í–∞–∂–Ω–æ:**
- –ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏, —Ç–µ–ø–ª–æ –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ, –∫–∞–∫ —Ä–∞–≤–Ω—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫
- –ò–∑–±–µ–≥–∞–π –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö —ç–º–æ–¥–∑–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π S1, S2, S3 –∏ —Ç.–¥.)
- –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –∑–¥–æ—Ä–æ–≤—å–µ, —ç–Ω–µ—Ä–≥–∏–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏, –∞ –Ω–µ –Ω–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –º–µ—Ç–∞—Ñ–æ—Ä–∞—Ö
- –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º –≤ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö"""

        return prompt

    def _generate_fallback_report(self, stats: dict[str, Any]) -> str:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è fallback –æ—Ç—á–µ—Ç–∞ –±–µ–∑ LLM.

        Args:
            stats: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é

        Returns:
            –ë–∞–∑–æ–≤—ã–π –æ—Ç—á–µ—Ç
        """
        recovery = stats.get("recovery", {})
        sleep = stats.get("sleep", {})
        workouts = stats.get("workouts", {})

        report = f"""üìä –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥ {stats.get('period', {}).get('start', 'N/A')} - {stats.get('period', {}).get('end', 'N/A')}

**Recovery:** –°—Ä–µ–¥–Ω–∏–π {recovery.get('avg', 'N/A')}% (—Ç—Ä–µ–Ω–¥: {recovery.get('trend', 'N/A')})
**–°–æ–Ω:** –°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å {sleep.get('avg_duration_hours', 'N/A')}—á, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å {sleep.get('avg_efficiency', 'N/A')}%
**Strain:** –°—Ä–µ–¥–Ω–∏–π {stats.get('strain', {}).get('avg', 'N/A')}
**–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:** {workouts.get('count', 0)} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫

–ü—Ä–æ–¥–æ–ª–∂–∞–π –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–≤–æ–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∂–∏–º –¥–ª—è –ª—É—á—à–µ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è!"""
        return report

